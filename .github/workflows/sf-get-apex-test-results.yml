name: Get Apex Test results

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  get-test-results:
    strategy:
      matrix:
        sf_org_alias: [STAGEFULL]

    env:
      ENVIRONMENT: ${{ matrix.sf_org_alias }}

    runs-on: ubuntu-latest
    container:
      image: salesforce/cli:latest-full

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download artifact with test run Id
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.sf_org_alias }}_test_run_id

    - name: Store test run id in env variable
      run: |
        cd ${{ matrix.sf_org_alias }}_test_run_id
        TEST_RUN_ID=$(cat ${{ matrix.sf_org_alias }}_test_run_id.txt)
        echo "TEST_RUN_ID=$TEST_RUN_ID" >> $GITHUB_ENV

    - name: Populate auth file with SFDX_URL secret of org
      run: echo "${{ secrets[format('SFDX_{0}_URL', env.ENVIRONMENT)] }}" > SFDX_${{ matrix.sf_org_alias }}_URL.txt

    - name: Authenticate Target Org
      run: sf org login sfdx-url -f SFDX_${{ matrix.sf_org_alias }}_URL.txt -s

    - name: Extract apex test results
      run: |
        sf apex get test -i ${{env.TEST_RUN_ID}} --json > test_results.json

    - name: Run Python script to parse test results and send to Datadog
      run: python3 parseApexTestResults.py test_results.json ${{ matrix.sf_org_alias }}

    